<html>
  <head>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<title>Sweeping App 2.0 with Gallery</title>
	<script>
	function touchMove(event) {
	    // Prevent scrolling on this element
	    event.preventDefault();
	    console.log("touchmove or start");
	    //removed
	};

    function myFunction() {
        return "Write something clever here...";
    };
	</script>
	
  </head>
  <body  onbeforeunload="return myFunction()">
    <div id="topbar" align="right" height="5%" width="100%">
		<input type=button onclick="maxSweep()" value="Hide all but SweepingApp">
		<input type=button onclick="showBoth()" value="Show SweepingApp and Gallery">
		<input type=button onclick="showGallery()" value="Hide Sweeper">
	</div>
   <div style="display: flex; flex-direction: row; width: 100%; height:95%">
	  <iframe id="sweep_frame"   src="sweeps.html" height="100%" width="78%" ></iframe>
      <iframe id="gallery_frame" src="Vandysweeps.html" height="100%" width="22%"></iframe>
    </div>
  </body>


  <script type="text/javascript">
	//MANAGE THE DISPLAY.
	function hideElement( framename, yesno ) {
		document.getElementById(framename).hidden = yesno;
	}
	
	function maxFrame( framename ) {
		document.getElementById(framename).width = "100%"
	}
	
	function maxSweep() {
		hideElement( "gallery_frame", true );
		hideElement( "topbar", true);
		hideElement( "sweep_frame", false);
		maxFrame("sweep_frame");
	}
	
	function showBoth() {
		hideElement( "gallery_frame", false );
		hideElement( "topbar", false);
		hideElement( "sweep_frame", false);
		document.getElementById("sweep_frame").width = "78%";
		document.getElementById("gallery_frame").width = "22%";
	}
	
	function showGallery() {
		hideElement( "gallery_frame", false );
		hideElement( "topbar", false);
		hideElement( "sweep_frame", true);
		maxFrame("gallery_frame");
	}


	//MANAGE THE COMMUNICATIONS
	//var domain = "http://rendupo.com:8000";
	var domain = "https://gallery.app.vanderbilt.edu";

	
	let makeEntriesFromFormData = function(obj, formData) {
	  for (let key in (obj || {})) {
	    formData.set(key, obj[key]);
	  }
	  return formData.entries();
	};

	//for safari.
	let makeEntriesShim = function(obj, formElem) {
	  let entryMap = new Map()

	  if (formElem !== undefined) {
	    Array.from(formElem.querySelectorAll("input[name]")).forEach((elem) => entryMap.set(elem.name, elem.value));
	  }

	  for (let key in (obj || {})) {
	    entryMap.set(key, obj[key]);
	  }

	  return Array.from(entryMap.entries());
	}

	window.makeQueryString = function(obj, formElem) {
	  let removeCRs = (str) => str.replace(/\r/g, '');
	  let formData  = new FormData(formElem);
	  let entries   = (formData.entries !== undefined) ? makeEntriesFromFormData(obj, formData) : makeEntriesShim(obj, formElem);
	  return Array.from(entries).map(([k, v]) => encodeURIComponent(k) + "=" + encodeURIComponent(removeCRs(v))).join("&");
	}

	window.upload = function(code, image, summary, uploader) {
  		let failback = function(response) {
			alert("Failed to post sweeper information...");
			response.text().then(function(body) { alert(JSON.stringify(body)) });
		};

		let callback = function(response) {
	    	if (response.status === 200) {
				alert("Successfully posted sweeper information.");
	    	} else {
	      		failback(response);
	    	}
	  	};

		let sn = window.location.hash
		while(sn.charAt(0) === '#') {
			sn = sn.substr(1);
		}
		console.log(sn);
	    if (sn.length < 1) { 
			sn = "public";
		}
	    let params = makeQueryString({ "session-id": sn, image, "data": JSON.stringify(code), "metadata": JSON.stringify({ summary, uploader }) });
  
		fetch(domain + "/uploads/", { method: "POST", body: params, headers: { "Content-Type": "application/x-www-form-urlencoded" } }).then(callback, failback);
		
		return false;
	};

	var inspectable;  //is this used?

    let receiveMessage = function(event) {
      switch (event.data.type) {
        case "upload-response":
		  console.log("response coming...");
		  document.getElementById("sweep_frame").contentWindow.postMessage(event.data, "*");
          //sweep_frame.contentWindow.postMessage(event.data, "*");
          break;
        case "import-settings":
		  console.log("settings coming...");
		  inspectable = event.data.code;
		  console.log(event.data.code);
		  document.getElementById("sweep_frame").contentWindow.postMessage(JSON.parse(event.data.code), "*");
          //sweep_frame.contentWindow.postMessage(JSON.parse(event.data.code), "*");
          break;
		case "export-settings":
		  console.log("message received to top level index.html");
		  console.log(event.data);
		  console.log(event.data.data);
		  console.log(event.data.image);
		  console.log(event.data.metadata.description);
		  console.log(event.data.metadata.name);
		  upload(event.data.data, event.data.image, event.data.metadata.description, event.data.metadata.name);
	  	  break;
		default:
          console.log("Lady Octopus: Ignoring message of type '" + event.type + "'");
      }
    }
    
  	window.addEventListener("message", receiveMessage, false);
  </script>
</html>
